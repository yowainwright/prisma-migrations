---
title: Writing Migrations
description: Learn how to write effective database migrations with Prisma Migrations
---

This guide covers how to write migrations in TypeScript or JavaScript with full type safety.

## Migration File Structure

Each migration is stored in its own directory with a `migration.ts` (or `migration.js`) file:

```bash
prisma/migrations/
└── [timestamp]_migration_name/
    └── migration.ts
```

The migration file exports two functions:
- `up()` - Applies the migration
- `down()` - Rolls back the migration

## Basic Migration Template

### TypeScript

```typescript
import type { PrismaClient } from 'prisma-migrations';

export async function up(prisma: PrismaClient) {
  // Your migration code here
}

export async function down(prisma: PrismaClient) {
  // Your rollback code here
}
```

### JavaScript

```javascript
exports.up = async function(prisma) {
  // Your migration code here
};

exports.down = async function(prisma) {
  // Your rollback code here
};
```

## Writing SQL Migrations

Use `$executeRaw` for SQL statements:

```typescript
import type { PrismaClient } from 'prisma-migrations';

export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    CREATE TABLE users (
      id SERIAL PRIMARY KEY,
      email VARCHAR(255) UNIQUE NOT NULL,
      name VARCHAR(255),
      created_at TIMESTAMP DEFAULT NOW()
    )
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`DROP TABLE IF EXISTS users`;
}
```

## Using Prisma Client Operations

You can use any Prisma Client method in migrations:

```typescript
import type { PrismaClient } from 'prisma-migrations';

export async function up(prisma: PrismaClient) {
  // Create table with raw SQL
  await prisma.$executeRaw`
    CREATE TABLE users (
      id SERIAL PRIMARY KEY,
      email VARCHAR(255) UNIQUE NOT NULL,
      role VARCHAR(50) DEFAULT 'user'
    )
  `;

  // Seed initial data using Prisma Client
  await prisma.user.createMany({
    data: [
      { email: 'admin@example.com', role: 'admin' },
      { email: 'user@example.com', role: 'user' },
    ],
  });
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`DROP TABLE IF EXISTS users`;
}
```

## Common Migration Patterns

### Creating Tables

```typescript
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    CREATE TABLE posts (
      id SERIAL PRIMARY KEY,
      title VARCHAR(255) NOT NULL,
      content TEXT,
      author_id INTEGER REFERENCES users(id),
      published BOOLEAN DEFAULT false,
      created_at TIMESTAMP DEFAULT NOW(),
      updated_at TIMESTAMP DEFAULT NOW()
    )
  `;

  // Create indexes
  await prisma.$executeRaw`
    CREATE INDEX idx_posts_author_id ON posts(author_id)
  `;

  await prisma.$executeRaw`
    CREATE INDEX idx_posts_published ON posts(published)
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`DROP TABLE IF EXISTS posts`;
}
```

### Adding Columns

```typescript
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users
    ADD COLUMN last_login TIMESTAMP
  `;

  await prisma.$executeRaw`
    ALTER TABLE users
    ADD COLUMN is_active BOOLEAN DEFAULT true
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users
    DROP COLUMN last_login
  `;

  await prisma.$executeRaw`
    ALTER TABLE users
    DROP COLUMN is_active
  `;
}
```

### Modifying Columns

```typescript
export async function up(prisma: PrismaClient) {
  // Change column type
  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN email TYPE TEXT
  `;

  // Add constraint
  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN name SET NOT NULL
  `;

  // Set default value
  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN role SET DEFAULT 'member'
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN email TYPE VARCHAR(255)
  `;

  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN name DROP NOT NULL
  `;

  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN role DROP DEFAULT
  `;
}
```

### Data Migrations

```typescript
export async function up(prisma: PrismaClient) {
  // Migrate existing data
  const users = await prisma.$queryRaw`
    SELECT id, name FROM users WHERE email IS NULL
  `;

  for (const user of users) {
    await prisma.$executeRaw`
      UPDATE users
      SET email = ${`${user.name}@example.com`}
      WHERE id = ${user.id}
    `;
  }

  // Now make email required
  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN email SET NOT NULL
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`
    ALTER TABLE users
    ALTER COLUMN email DROP NOT NULL
  `;
}
```

### Creating Indexes

```typescript
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`
    CREATE INDEX idx_users_email ON users(email)
  `;

  await prisma.$executeRaw`
    CREATE INDEX idx_users_created_at ON users(created_at)
  `;

  // Unique index
  await prisma.$executeRaw`
    CREATE UNIQUE INDEX idx_users_username ON users(username)
  `;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`DROP INDEX IF EXISTS idx_users_email`;
  await prisma.$executeRaw`DROP INDEX IF EXISTS idx_users_created_at`;
  await prisma.$executeRaw`DROP INDEX IF EXISTS idx_users_username`;
}
```

## Best Practices

### 1. Always Write Down Migrations

Every `up()` should have a corresponding `down()` that reverses it:

```typescript
// ✓ Good
export async function up(prisma: PrismaClient) {
  await prisma.$executeRaw`CREATE TABLE foo (...)`;
}

export async function down(prisma: PrismaClient) {
  await prisma.$executeRaw`DROP TABLE IF EXISTS foo`;
}

// ✗ Bad - Empty down function
export async function down(prisma: PrismaClient) {
  // Nothing here!
}
```

### 2. Use Transactions for Complex Migrations

```typescript
export async function up(prisma: PrismaClient) {
  await prisma.$transaction(async (tx) => {
    await tx.$executeRaw`CREATE TABLE foo (id SERIAL PRIMARY KEY)`;
    await tx.$executeRaw`CREATE TABLE bar (id SERIAL PRIMARY KEY)`;
    await tx.$executeRaw`ALTER TABLE bar ADD FOREIGN KEY (foo_id) REFERENCES foo(id)`;
  });
}
```

### 3. Handle Data Migrations Safely

```typescript
export async function up(prisma: PrismaClient) {
  // Get existing data
  const users = await prisma.user.findMany();

  // Transform and update
  for (const user of users) {
    if (!user.displayName) {
      await prisma.user.update({
        where: { id: user.id },
        data: { displayName: user.email.split('@')[0] }
      });
    }
  }
}
```

### 4. Use Descriptive Migration Names

```bash
# ✓ Good
npx prisma-migrations create add_user_email_verification
npx prisma-migrations create modify_posts_add_published_at

# ✗ Bad
npx prisma-migrations create update
npx prisma-migrations create changes
```

### 5. Test Migrations Thoroughly

Test both up and down:

```bash
# Test up
npx prisma-migrations up

# Verify changes
psql -d mydb -c "\d users"

# Test down
npx prisma-migrations down

# Verify rollback
psql -d mydb -c "\d users"
```

## Advanced Patterns

### Conditional Migrations

```typescript
export async function up(prisma: PrismaClient) {
  // Check if column exists
  const result = await prisma.$queryRaw`
    SELECT column_name
    FROM information_schema.columns
    WHERE table_name='users' AND column_name='email'
  `;

  if (result.length === 0) {
    await prisma.$executeRaw`
      ALTER TABLE users ADD COLUMN email VARCHAR(255)
    `;
  }
}
```

### Multi-Step Migrations

```typescript
export async function up(prisma: PrismaClient) {
  // Step 1: Add new column
  await prisma.$executeRaw`
    ALTER TABLE users ADD COLUMN new_email VARCHAR(255)
  `;

  // Step 2: Copy data
  await prisma.$executeRaw`
    UPDATE users SET new_email = old_email
  `;

  // Step 3: Drop old column
  await prisma.$executeRaw`
    ALTER TABLE users DROP COLUMN old_email
  `;

  // Step 4: Rename new column
  await prisma.$executeRaw`
    ALTER TABLE users RENAME COLUMN new_email TO email
  `;
}

export async function down(prisma: PrismaClient) {
  // Reverse all steps
  await prisma.$executeRaw`
    ALTER TABLE users RENAME COLUMN email TO new_email
  `;

  await prisma.$executeRaw`
    ALTER TABLE users ADD COLUMN old_email VARCHAR(255)
  `;

  await prisma.$executeRaw`
    UPDATE users SET old_email = new_email
  `;

  await prisma.$executeRaw`
    ALTER TABLE users DROP COLUMN new_email
  `;
}
```

### Environment-Specific Logic

```typescript
export async function up(prisma: PrismaClient) {
  const isDev = process.env.NODE_ENV === 'development';

  await prisma.$executeRaw`CREATE TABLE users (id SERIAL PRIMARY KEY)`;

  // Seed data in development only
  if (isDev) {
    await prisma.user.createMany({
      data: [
        { email: 'dev@example.com' },
        { email: 'test@example.com' }
      ]
    });
  }
}
```

## Database-Specific Examples

### PostgreSQL

```typescript
// JSON columns
await prisma.$executeRaw`
  ALTER TABLE users ADD COLUMN metadata JSONB DEFAULT '{}'
`;

// Arrays
await prisma.$executeRaw`
  ALTER TABLE users ADD COLUMN tags TEXT[] DEFAULT ARRAY[]::TEXT[]
`;

// Full-text search
await prisma.$executeRaw`
  ALTER TABLE posts ADD COLUMN search_vector TSVECTOR
`;

await prisma.$executeRaw`
  CREATE INDEX idx_posts_search ON posts USING GIN(search_vector)
`;
```

### MySQL

```typescript
// JSON columns
await prisma.$executeRaw`
  ALTER TABLE users ADD COLUMN metadata JSON
`;

// Fulltext index
await prisma.$executeRaw`
  ALTER TABLE posts ADD FULLTEXT INDEX idx_posts_content (content)
`;
```

## Troubleshooting

### Migration Failed Mid-Way

If a migration fails partway through:

1. Check your database state
2. Fix the migration code
3. Either:
   - Manually clean up partial changes and retry
   - Or write a new migration to continue from current state

### Type Errors

If you get TypeScript errors, ensure you're importing the correct PrismaClient type:

```typescript
// ✓ Correct
import type { PrismaClient } from 'prisma-migrations';

// ✗ Wrong
import { PrismaClient } from '@prisma/client';
```

### Down Migration Doesn't Work

Make sure your down() properly reverses up():

```typescript
// Test both directions
await migrations.up();
await migrations.down();
await migrations.up(); // Should work again
```

## Next Steps

- Learn about [Advanced Features](/prisma-migrations/docs/advanced-features) like interactive mode
- Explore the [API Reference](/prisma-migrations/docs/api-reference) for programmatic usage
- Check [Troubleshooting](/prisma-migrations/docs/troubleshooting) for common issues
